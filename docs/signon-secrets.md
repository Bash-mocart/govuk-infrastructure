# Signon secrets

Many apps running in ECS have the following secrets:

* GDS_SSO_OAUTH_ID
* GDS_SSO_OAUTH_SECRET
* <app>_BEARER_TOKEN

These are OAuth credentials generated by the [Signon][] app, which is an
OAuth2 based single sign-on provider. See the Signon docs for more details
about what these credentials are for.

## Bootstrapping

These credentials are pulled from SecretsManager by ECS when starting a
container. If the credentials don't exist, or there is no current version
of one these secrets, then the container won't start and ECS may or may not
retry the operation depending on whether the task is part of an ECS Service.

These credentials are generated automatically when bringing up a new workspace.

The `govuk-publishing-platform` terraform deployment creates the secretsmanager
secret for each required credential that Signon will later generate.

Once the Concourse deploy pipeline has applied the `govuk-publishing-platform`
terraform deployment, it will attempt to deploy all of the apps.

Any app that requires a secret which does not yet have a version will wait
for credentials to be set. For example the deploy-content-store job has this
blocking task, that ensures that we attempt a deployment only once all the
credentials required by this task have been set in SecretsManager.

```yaml
- <<: *await-secretsmanager-creds
  params:
    APPLICATION: content-store
    VARIANT: live
```

Meanwhile the `deploy-signon` job will run. Once Signon is running, Concourse
will use the Signon API to create the necessary Signon resources (Apps, ApiUsers)
which will generate credentials which Concourse will set as the current
secret versions in SecretsManager.

Finally, the other deploy jobs will stop waiting for the SecretsManager
credentials to be set (they poll the secret for a current version) and will
deploy. Each Concourse app deployment will create the necessary bearer tokens
the app needs by sending requests to Signon's API and setting the secrets in
SecretsManager.

Eventually all secrets will be set in SecretsManager and all apps will be started.

## Deploying

Every time we deploy signon, the Concourse pipeline will check that all of the
necessary resources (apps, users) exist in Signon, or else it will create them.

This enables one to add new apps to Signon through config, rather than a rake
task which was the previous method.

The pipeline won't delete old resources - currently we must delete those manually.

When we deploy apps, Concourse app deploy jobs will check that their secrets
exist before deploying. If an app deployment job spots that it doesn't have a
bearer token it needs, it will create one.

## Rotation

We use the SecretsManager Lambda rotation function to rotate Signon bearer
tokens. Signon bearer tokens generated by Signon's API auto-expire after 60 days.

The Lambda rotation functions (all defined in Terraform config and in the
`lambdas` directory of this repository) will be triggered by SecretsManager
every 30 days to rotate the credentials.

We haven't yet implemented a way for the ECS Tasks which use previous
credentials to be replaced automatically when a bearer token is rotated.
We'll need to do that before we deploy to production.

[Signon]: https://github.com/alphagov/signon
