# Signon secrets

Many apps running in EKS have the following secrets:

* GDS_SSO_OAUTH_ID
* GDS_SSO_OAUTH_SECRET
* <app>_BEARER_TOKEN

These are OAuth credentials generated by the [Signon][] app, which is an
OAuth2 based single sign-on provider. See the Signon docs for more details
about what these credentials are for.

## Bootstrapping

Signon credentials are generated automatically when bringing up a new cluster.

Signon credentials are pulled from a Secret by Kubernetes when starting a
container. If the Secret does not exist, then the container won't start and
Kubernetes or Argo may re-attempt the operation.

The [signon-resources] Helm chart contains a Job that creates a corresponding
Secret for each required credential that Signon generates.
Application deployments will fail until the `signon-resources` bootstrapping
job has completed successfully.

The `signon-resources` Helm chart runs the Rake task defined in
`govuk-infrastructure` (this repository), which calls Signon's API to
create Signon resources, and calls the Kubernetes API to create and update
Secrets in the `apps` namespace.

Eventually all required Secret objects will be present in the `apps` namespace
and all pods requiring Signon credentials will be started successfully.

[signon-resources]: https://github.com/alphagov/govuk-helm-charts/tree/main/charts/signon-resources

## Deploying

It is important that we manage Signon resources in config to make it possible
to bootstrap the GOV.UK cluster automatically.
You may create Signon resources manually, but please ensure you update the
configuration to match your changes.

To add new Signon resources (such as a new bearer token, OAuth application),
you must modify the `bootstrap-job.yaml` in the `signon-resources` Helm chart.

The bootstrap job does not delete old resources - you should delete those manually.

## Rotation

Bearer token rotation not yet implemented for Kubernetes.
In the EKS platform we used AWS SecretsManager and a rotation Lambda to
implement this feature.

[Signon]: https://github.com/alphagov/signon
