---
definitions:

resource_types:
  - name: slack-notification
    type: docker-image
    source:
      repository: cfcommunity/slack-notification-resource
      tag: latest # TODO - don't use latest (once we've worked out a policy for third party images)
      username: ((docker_hub_username))
      password: ((docker_hub_authtoken))

  - name: s3
    type: docker-image
    source:
      repository: governmentpaas/s3-resource
      tag: latest # TODO - don't use latest (once we've worked out a policy for third party images)

resources:
  - &git-repo
    icon: github
    name: govuk-infrastructure
    source: &govuk-infrastructure-source
      branch: main
      uri: https://github.com/alphagov/govuk-infrastructure
    type: git

  - <<: *git-repo
    name: frontend
    source:
      branch: master
      uri: https://github.com/alphagov/frontend
      tag_filter: release_*

  - <<: *git-repo
    name: govuk-infrastructure-frontend
    source:
      <<: *govuk-infrastructure-source
      paths:
        - concourse/tasks
        - terraform/deployments/apps/*frontend
        # TODO replace these once frontend is refactored to use the new modules
        - terraform/modules/task-definition
        - terraform/modules/task-definitions/frontend

  - <<: *git-repo
    name: publisher
    source:
      branch: master
      uri: https://github.com/alphagov/publisher
      tag_filter: release_*

  - <<: *git-repo
    name: govuk-infrastructure-publisher
    source:
      <<: *govuk-infrastructure-source
      paths:
        - concourse/tasks
        - terraform/deployments/apps/publisher*
        # TODO replace these once publisher is refactored to use the new modules
        - terraform/modules/task-definition
        - terraform/modules/task-definitions/publisher

  - <<: *git-repo
    name: publishing-api
    source:
      branch: master
      uri: https://github.com/alphagov/publishing-api
      tag_filter: release_*

  - <<: *git-repo
    name: govuk-infrastructure-publishing-api
    source:
      <<: *govuk-infrastructure-source
      paths:
        - concourse/tasks
        - terraform/deployments/apps/publishing-api
        # TODO replace these once publishing-api is refactored to use the new modules
        - terraform/modules/task-definition
        - terraform/modules/task-definitions/publishing-api

  - <<: *git-repo
    name: content-store
    source:
      branch: master
      uri: https://github.com/alphagov/content-store
      tag_filter: release_*

  - <<: *git-repo
    name: govuk-infrastructure-concourse-tasks
    icon: concourse-ci
    source:
      <<: *govuk-infrastructure-source
      paths: [ concourse/tasks ]

  - <<: *git-repo
    name: router
    source:
      branch: master
      uri: https://github.com/alphagov/router
      tag_filter: release_*

  - <<: *git-repo
    name: govuk-infrastructure-router
    source:
      <<: *govuk-infrastructure-source
      paths:
        - concourse/tasks
        - terraform/deployments/apps/*router
        # TODO replace these once router is refactored to use the new modules
        - terraform/modules/task-definition
        - terraform/modules/task-definitions/router

  - <<: *git-repo
    name: router-api
    source:
      branch: master
      uri: https://github.com/alphagov/router-api
      tag_filter: release_*

  - <<: *git-repo
    name: govuk-infrastructure-router-api
    source:
      <<: *govuk-infrastructure-source
      paths:
        - concourse/tasks
        - terraform/deployments/apps/*router-api
        # TODO replace these once router-api is refactored to use the new modules
        - terraform/modules/task-definition
        - terraform/modules/task-definitions/router-api

  - <<: *git-repo
    name: signon
    source:
      branch: master
      uri: https://github.com/alphagov/signon
      tag_filter: release_*

  - <<: *git-repo
    name: govuk-infrastructure-signon
    source:
      <<: *govuk-infrastructure-source
      paths:
        - concourse/tasks
        - terraform/deployments/apps/signon
        # TODO replace these once signon is refactored to use the new modules
        - terraform/modules/task-definition
        - terraform/modules/task-definitions/signon

  - <<: *git-repo
    name: static
    source:
      branch: master
      uri: https://github.com/alphagov/static
      tag_filter: release_*

  - <<: *git-repo
    name: govuk-infrastructure-static
    source:
      <<: *govuk-infrastructure-source
      paths:
        - concourse/tasks
        - terraform/deployments/apps/static
        # TODO replace these once static is refactored to use the new modules
        - terraform/modules/task-definition
        - terraform/modules/task-definitions/static

  - name: deploy-slack-channel
    type: slack-notification
    icon: bell-ring
    source:
      url: https://hooks.slack.com/services/((slack_webhook))

  - name: govuk-terraform-outputs
    type: s3
    icon: file
    # NOTE: this bucket is created for us by Big Concourse
    # https://reliability-engineering.cloudapps.digital/continuous-deployment.html#services
    # It's in AWS' London region (eu-west-2)
    source:
      bucket: ((readonly_private_bucket_name))
      region_name: eu-west-2
      versioned_file: govuk-terraform-outputs.json

  - name: content-store-terraform-outputs
    type: s3
    icon: file
    # NOTE: this bucket is created for us by Big Concourse
    # https://reliability-engineering.cloudapps.digital/continuous-deployment.html#services
    # It's in AWS' London region (eu-west-2)
    source:
      bucket: ((readonly_private_bucket_name))
      region_name: eu-west-2
      versioned_file: content-store.json
      initial_version: "0"

groups:
  - name: all
    jobs:
      - update-pipeline
      - run-terraform
      - deploy-content-store
      - deploy-frontend
      - smoke-test-frontend
      - deploy-draft-frontend
      - deploy-publisher
      - deploy-publishing-api
      - deploy-router
      - deploy-draft-router
      - deploy-router-api
      - deploy-draft-router-api
      - deploy-signon
      - deploy-static
      - deploy-draft-static

  - name: terraform
    jobs:
      - run-terraform

  - name: admin
    jobs:
      - update-pipeline

  - name: frontend
    jobs:
      - deploy-frontend
      - deploy-draft-frontend
      - smoke-test-frontend

  - name: publisher
    jobs:
      - deploy-publisher

  - name: publishing-api
    jobs:
      - deploy-publishing-api

  - name: router
    jobs:
      - deploy-router
      - deploy-draft-router

  - name: router-api
    jobs:
      - deploy-router-api
      - deploy-draft-router-api

  - name: signon
    jobs:
      - deploy-signon

  - name: static
    jobs:
      - deploy-static
      - deploy-draft-static

jobs:
  - name: update-pipeline
    plan:
    - get: govuk-infrastructure
      trigger: true
    - file: govuk-infrastructure/concourse/pipelines/deploy.yml
      set_pipeline: deploy-apps-test

  - name: run-terraform
    serial: true
    plan:
    - get: govuk-infrastructure
      trigger: true
    - get: content-store-terraform-outputs
    - task: terraform-apply
      config:
        inputs:
        - name: govuk-infrastructure
        - name: content-store-terraform-outputs
          path: original-content-store-terraform-outputs
          optional: true
        outputs:
        - name: govuk-terraform-outputs
        - name: content-store-terraform-outputs
          path: updated-content-store-terraform-outputs
        params:
          AWS_REGION: eu-west-1
          ASSUME_ROLE_ARN: 'arn:aws:iam::430354129336:role/govuk-concourse-deployer'
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: governmentpaas/terraform
            tag: terraform-0.13.3
            username: ((docker_hub_username))
            password: ((docker_hub_authtoken))
        run:
          path: sh
          args:
          - '-c'
          - |
            set -eu

            root_dir=$(pwd)

            cd govuk-infrastructure/terraform/deployments/govuk-publishing-platform

            terraform init -backend-config "role_arn=$ASSUME_ROLE_ARN"
            terraform apply \
              -var "assume_role_arn=$ASSUME_ROLE_ARN" \
              -var-file ../variables/test/common.tfvars \
              -var-file ../variables/test/infrastructure.tfvars \
              -auto-approve

            terraform output -json > "$root_dir/govuk-terraform-outputs/govuk-terraform-outputs.json"

            update_terraform_outputs() {
              app="$1"
              terraform output -json "${app}" > "$root_dir/updated-${app}-terraform-outputs/${app}.json"

              if cmp \
                "$root_dir/original-${app}-terraform-outputs/${app}.json" \
                "$root_dir/updated-${app}-terraform-outputs/${app}.json"
              then
                # If the updated terraform outputs are the same as the originals
                # delete them to avoid unnecessarily creating a new resource version
                rm "$root_dir/updated-${app}-terraform-outputs/${app}.json"
              fi
            }

            update_terraform_outputs content-store

    - put: govuk-terraform-outputs
      params:
        file: govuk-terraform-outputs/govuk-terraform-outputs.json
    - try:
        put: content-store-terraform-outputs
        params:
          file: content-store-terraform-outputs/content-store.json

  - name: deploy-frontend
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-frontend
        trigger: true
      - get: govuk-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - get: release
        resource: frontend
        trigger: true
    - task: update-task-definition
      file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
      params:
        APPLICATION: frontend
        GOVUK_ENVIRONMENT: test
    - task: update-ecs-service
      file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
      params:
        ECS_SERVICE: frontend
        GOVUK_ENVIRONMENT: test
    serial: true
    on_failure: &notify-slack-failure
      put: deploy-slack-channel
      params:
        channel: "#govuk-deploy-alerts"
        username: 'Concourse deploy pipeline'
        icon_emoji: ':concourse:'
        silent: true
        text: |
          :red_circle: Failed build: http://cd.gds-reliability.engineering/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

  - name: smoke-test-frontend
    plan:
    - get: govuk-infrastructure
      resource: govuk-infrastructure-frontend
      passed:
      - deploy-frontend
      trigger: true
    - task: fetch-smoke-tests
      file: govuk-infrastructure/concourse/tasks/fetch-task-definition.yml
      params:
        APPLICATION: smokey
        GOVUK_ENVIRONMENT: test
    - task: run-smoke-tests
      file: govuk-infrastructure/concourse/tasks/run-task.yml
      params:
        APPLICATION: smokey
        COMMAND: bundle exec cucumber --profile test --strict-undefined -t @replatforming -t \"not @notreplatforming\"

  - name: deploy-draft-frontend
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-frontend
        trigger: true
      - get: govuk-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - get: release
        resource: frontend
        trigger: true
    - task: update-task-definition
      file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
      params:
        APPLICATION: draft-frontend
        GOVUK_ENVIRONMENT: test
    - task: update-ecs-service
      file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
      params:
        ECS_SERVICE: draft-frontend
        GOVUK_ENVIRONMENT: test
    serial: true
    on_failure: &notify-slack-failure
      put: deploy-slack-channel
      params:
        channel: "#govuk-deploy-alerts"
        username: 'Concourse deploy pipeline'
        icon_emoji: ':concourse:'
        silent: true
        text: |
          :red_circle: Failed build: http://cd.gds-reliability.engineering/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME


  - name: deploy-publisher
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-publisher
        trigger: true
      - get: govuk-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - get: release
        resource: publisher
        trigger: true
    - task: update-web-task-definition
      file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
      params:
        APPLICATION: publisher-web
        GOVUK_ENVIRONMENT: test
    - task: update-worker-task-definition
      file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
      params:
        APPLICATION: publisher-worker
        GOVUK_ENVIRONMENT: test
    - task: run-db-migrations
      file: govuk-infrastructure/concourse/tasks/run-task.yml
      params:
        APPLICATION: publisher-web
        COMMAND: "bundle exec rails db:migrate"
        TASK_DEFINITION: web_task_definition
    - in_parallel:
      - task: update-web-ecs-service
        file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
        params:
          ECS_SERVICE: publisher-web
          GOVUK_ENVIRONMENT: test
          TASK_DEFINITION: web_task_definition
      - task: update-worker-ecs-service
        file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
        params:
          ECS_SERVICE: publisher-worker
          GOVUK_ENVIRONMENT: test
          TASK_DEFINITION: worker_task_definition
    serial: true
    on_failure:
      <<: *notify-slack-failure

  - name: deploy-publishing-api
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-publishing-api
        trigger: true
      - get: govuk-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - get: release
        resource: publishing-api
        trigger: true
    - task: update-web-task-definition
      file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
      params:
        APPLICATION: publishing-api-web
        GOVUK_ENVIRONMENT: test
    - task: update-worker-task-definition
      file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
      params:
        APPLICATION: publishing-api-worker
        GOVUK_ENVIRONMENT: test
    - in_parallel:
      - task: update-web-ecs-service
        file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
        params:
          ECS_SERVICE: publishing-api-web
          GOVUK_ENVIRONMENT: test
          TASK_DEFINITION: web_task_definition
      - task: update-worker-ecs-service
        file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
        params:
          ECS_SERVICE: publishing-api-worker
          GOVUK_ENVIRONMENT: test
          TASK_DEFINITION: worker_task_definition
    serial: true
    on_failure:
      <<: *notify-slack-failure

  - name: deploy-content-store
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-concourse-tasks
        trigger: true
      - get: app-terraform-outputs
        resource: content-store-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - get: release
        resource: content-store
        trigger: true
    - in_parallel:
      - task: update-draft-task-definition
        file: govuk-infrastructure/concourse/tasks/update-task-definition-v2.yml
        output_mapping:
          task-definition-arn: draft-task-definition-arn
        params:
          APPLICATION: content-store
          VARIANT: draft
          PIN_IMAGE_TAG: bill-content-schemas # TODO - remove this once content-store supports content-schemas
      - task: update-live-task-definition
        file: govuk-infrastructure/concourse/tasks/update-task-definition-v2.yml
        output_mapping:
          task-definition-arn: live-task-definition-arn
        params:
          APPLICATION: content-store
          VARIANT: live
          PIN_IMAGE_TAG: bill-content-schemas # TODO - remove this once content-store supports content-schemas
    - in_parallel:
      - task: update-live-ecs-service
        file: govuk-infrastructure/concourse/tasks/update-ecs-service-v2.yml
        input_mapping:
          task-definition-arn: live-task-definition-arn
        params:
          ECS_SERVICE: content-store
      - task: update-draft-ecs-service
        file: govuk-infrastructure/concourse/tasks/update-ecs-service-v2.yml
        input_mapping:
          task-definition-arn: draft-task-definition-arn
        params:
          ECS_SERVICE: draft-content-store
    serial: true
    on_failure:
      <<: *notify-slack-failure

  - name: deploy-router
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-router
        trigger: true
      - get: govuk-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - get: release
        resource: router
        trigger: true
    - task: update-task-definition
      file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
      params:
        APPLICATION: router
        GOVUK_ENVIRONMENT: test
    - task: update-ecs-service
      file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
      params:
        ECS_SERVICE: router
        GOVUK_ENVIRONMENT: test
    serial: true
    on_failure:
      <<: *notify-slack-failure

  - name: deploy-draft-router
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-router
        trigger: true
      - get: govuk-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - get: release
        resource: router
        trigger: true
    - task: update-task-definition
      file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
      params:
        APPLICATION: draft-router
        GOVUK_ENVIRONMENT: test
    - task: update-ecs-service
      file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
      params:
        ECS_SERVICE: draft-router
        GOVUK_ENVIRONMENT: test
    serial: true
    on_failure:
      <<: *notify-slack-failure

  - name: deploy-router-api
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-router-api
        trigger: true
      - get: govuk-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - get: release
        resource: router-api
        trigger: true
    - task: update-task-definition
      file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
      params:
        APPLICATION: router-api
        GOVUK_ENVIRONMENT: test
    - task: update-ecs-service
      file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
      params:
        ECS_SERVICE: router-api
        GOVUK_ENVIRONMENT: test
    serial: true
    on_failure:
      <<: *notify-slack-failure

  - name: deploy-draft-router-api
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-router-api
        trigger: true
      - get: govuk-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - get: release
        resource: router-api
        trigger: true
    - task: update-task-definition
      file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
      params:
        APPLICATION: draft-router-api
        GOVUK_ENVIRONMENT: test
    - task: update-ecs-service
      file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
      params:
        ECS_SERVICE: draft-router-api
        GOVUK_ENVIRONMENT: test
    serial: true
    on_failure:
      <<: *notify-slack-failure

  - name: deploy-signon
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-signon
        trigger: true
      - get: govuk-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - get: release
        resource: signon
        trigger: true
    - task: update-task-definition
      file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
      params:
        APPLICATION: signon
        GOVUK_ENVIRONMENT: test
    - task: update-ecs-service
      file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
      params:
        ECS_SERVICE: signon
        GOVUK_ENVIRONMENT: test
    serial: true
    on_failure:
      <<: *notify-slack-failure

  - name: deploy-static
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-static
        trigger: true
      - get: govuk-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - get: release
        resource: static
        trigger: true
    - task: update-task-definition
      file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
      params:
        APPLICATION: static
        GOVUK_ENVIRONMENT: test
    - task: update-ecs-service
      file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
      params:
        ECS_SERVICE: static
        GOVUK_ENVIRONMENT: test
    serial: true
    on_failure:
      <<: *notify-slack-failure

  - name: deploy-draft-static
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-static
        trigger: true
      - get: govuk-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - get: release
        resource: static
        trigger: true
    - task: update-task-definition
      file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
      params:
        APPLICATION: draft-static
        GOVUK_ENVIRONMENT: test
    - task: update-ecs-service
      file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
      params:
        ECS_SERVICE: draft-static
        GOVUK_ENVIRONMENT: test
    serial: true
    on_failure:
      <<: *notify-slack-failure
